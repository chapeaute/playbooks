- name: application | create conf directory
  file:
    dest: "/etc/{{ java_app.name }}"
    state: directory
  notify:
    - Restart tomcat

- name: application | create logging directory
  file:
    dest:  "{{ java_app.log_file | dirname }}"
    state: directory
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    mode:  0750
  notify:
    - Restart tomcat

- name: application | configure Tomcat7 classpath loader
  lineinfile:
    dest:   "{{ tomcat_conf_path }}/catalina.properties"
    regexp: '^(common.loader=(?:.(?!/etc/{{ java_app.name }}))*)$'
    line:   '\1,/etc/{{ java_app.name }}'
    backrefs: yes
  notify:
    - Restart tomcat

- name: application | copy configuration
  template:
    src:   "{{ item }}.j2"
    dest:  "/etc/{{ java_app.name }}/{{ item|basename }}"
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    mode:  0640
  with_items: "{{ java_app.conf_files|default([]) }}"
  notify:
    - Restart tomcat

- name: application | copy logrotate configuration
  template:
    src:  "{{ java_app.logrotate_conf }}"
    dest: "/etc/logrotate.d/{{ java_app.name }}"
  when: java_app.logrotate_conf is defined

- name: application | copy context
  template:
    src:  "{{ java_app.context }}"
    dest: "{{ tomcat_conf_path }}/Catalina/localhost/{{ java_app.name }}.xml"
    mode: 0644
  when: java_app.context is defined
  notify:
    - Restart tomcat

- name: application | copy war
  copy:
    src:  "{{ java_app.war }}"
    dest: "{{ tomcat_webapp_path }}/{{ java_app.name }}.war"
  notify:
    - remove old java application
    - Restart tomcat
